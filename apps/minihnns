<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Idle Hack&Slash (Phase 1)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.5; }
    button { padding: 10px 12px; margin: 4px 6px 4px 0; }
    .row { margin: 10px 0; }
    .box { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Mini Idle Hack&Slash（Phase 1）</h1>

  <div class="row">
    <button id="btnStart">周回開始</button>
    <button id="btnStop">停止</button>
    <button id="btnReset">リセット（セーブ含む）</button>
  </div>

  <div class="box">
    <div>状態: <span id="status" class="mono">IDLE</span></div>
    <div>敵HP: <span id="enemyHp" class="mono">-</span> / <span id="enemyHpMax" class="mono">-</span></div>
    <div>自分DPS: <span id="dps" class="mono">-</span></div>
    <div>所持Gold: <span id="gold" class="mono">-</span></div>
    <div>周回数: <span id="runs" class="mono">-</span></div>
  </div>

  <div class="box">
    <div>ログ</div>
    <pre id="log" class="mono" style="white-space:pre-wrap; margin:0;"></pre>
  </div>

<script>
(() => {
  'use strict';

  /*********************
   * 定数（Phase 1）
   *********************/
  const SAVE_KEY = 'mini_hns_phase1_v1';
  const TICK_MS = 100; // 100ms刻みで進行
  const BASE_DPS = 5;
  const BASE_ENEMY_HP = 50;
  const ENEMY_HP_GROWTH_PER_RUN = 10; // 周回ごとにHP増（Phase 1のインフレの種）
  const GOLD_REWARD_BASE = 10;

  /*********************
   * 状態
   *********************/
  let state = {
    gold: 0,
    runs: 0,
    dps: BASE_DPS,
    enemyHpMax: BASE_ENEMY_HP,
    enemyHp: BASE_ENEMY_HP,
    inRun: false,
  };

  let timerId = null;

  /*********************
   * DOM
   *********************/
  const $ = (id) => document.getElementById(id);

  const elStatus = $('status');
  const elEnemyHp = $('enemyHp');
  const elEnemyHpMax = $('enemyHpMax');
  const elDps = $('dps');
  const elGold = $('gold');
  const elRuns = $('runs');
  const elLog = $('log');

  const btnStart = $('btnStart');
  const btnStop = $('btnStop');
  const btnReset = $('btnReset');

  /*********************
   * ログ
   *********************/
  function log(line) {
    const ts = new Date().toLocaleString();
    elLog.textContent = `[${ts}] ${line}\n` + elLog.textContent;
  }

  /*********************
   * セーブ/ロード
   *********************/
  function save() {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }

  function load() {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    try {
      const parsed = JSON.parse(raw);
      // 期待フィールドだけを反映（壊れたデータを防ぐ）
      state.gold = Number(parsed.gold) || 0;
      state.runs = Number(parsed.runs) || 0;
      state.dps = Number(parsed.dps) || BASE_DPS;
      state.enemyHpMax = Number(parsed.enemyHpMax) || BASE_ENEMY_HP;
      state.enemyHp = Number(parsed.enemyHp) || state.enemyHpMax;
      state.inRun = Boolean(parsed.inRun);
      return true;
    } catch (e) {
      return false;
    }
  }

  function resetAll() {
    stopRun();
    localStorage.removeItem(SAVE_KEY);
    state = {
      gold: 0,
      runs: 0,
      dps: BASE_DPS,
      enemyHpMax: BASE_ENEMY_HP,
      enemyHp: BASE_ENEMY_HP,
      inRun: false,
    };
    render();
    log('リセットしました。');
  }

  /*********************
   * ゲーム進行
   *********************/
  function prepareNextEnemy() {
    // 周回数に応じて敵HPを増やす（Phase 1の単純インフレ）
    state.enemyHpMax = BASE_ENEMY_HP + (state.runs * ENEMY_HP_GROWTH_PER_RUN);
    state.enemyHp = state.enemyHpMax;
  }

  function startRun() {
    if (state.inRun) return;
    state.inRun = true;
    prepareNextEnemy();
    render();
    log(`周回開始：敵HP=${state.enemyHpMax}, DPS=${state.dps}`);

    // 既存タイマーがあれば停止してから開始
    if (timerId) clearInterval(timerId);
    timerId = setInterval(tick, TICK_MS);
  }

  function stopRun() {
    state.inRun = false;
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
    render();
  }

  function tick() {
    if (!state.inRun) return;

    // 100msで進むダメージ量 = DPS * (tick秒)
    const damage = state.dps * (TICK_MS / 1000);
    state.enemyHp = Math.max(0, state.enemyHp - damage);

    if (state.enemyHp <= 0) {
      // 撃破
      state.runs += 1;
      const reward = GOLD_REWARD_BASE; // Phase 1では固定報酬
      state.gold += reward;
      log(`撃破！ +${reward}G（累計G=${state.gold} / 周回=${state.runs}）`);

      // 次の敵へ（自動周回）
      prepareNextEnemy();
      log(`次の敵：HP=${state.enemyHpMax}`);
    }

    save();
    render();
  }

  /*********************
   * 表示
   *********************/
  function render() {
    elStatus.textContent = state.inRun ? 'RUNNING' : 'IDLE';
    elEnemyHp.textContent = Math.ceil(state.enemyHp).toString();
    elEnemyHpMax.textContent = Math.ceil(state.enemyHpMax).toString();
    elDps.textContent = state.dps.toString();
    elGold.textContent = state.gold.toString();
    elRuns.textContent = state.runs.toString();
  }

  /*********************
   * イベント
   *********************/
  btnStart.addEventListener('click', () => startRun());
  btnStop.addEventListener('click', () => { log('停止しました。'); stopRun(); save(); });
  btnReset.addEventListener('click', () => resetAll());

  /*********************
   * 初期化
   *********************/
  const loaded = load();
  render();
  log(loaded ? 'セーブデータをロードしました。' : '新規開始です。');

  // ロード時にinRun=trueだった場合でも、勝手に再開はしない（操作を単純化）
  // 必要ならPhase 2以降で「自動再開」を入れます。
  state.inRun = false;
  save();
  render();
})();
</script>
</body>
</html>
