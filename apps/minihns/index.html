<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mini Idle Hack&Slash (Phase 3)</title>

<style>
body { font-family: system-ui, sans-serif; padding:16px; }
button { padding:8px 12px; margin:4px 6px 4px 0; }
.box { border:1px solid #ddd; border-radius:8px; padding:10px; margin:10px 0; }
.mono { font-family: ui-monospace, monospace; }
.enemyArea { position:relative; width:160px; height:160px; }
#enemyImg { width:160px; height:160px; cursor:pointer; }
.float { position:absolute; font-weight:700; animation: float 0.5s forwards; pointer-events:none; }
@keyframes float { to { transform:translateY(-24px); opacity:0; } }
.weapon-common { color:#333; }
.weapon-rare { color:#1e6bff; font-weight:700; }
</style>
</head>

<body>
<h1>Mini Idle Hack&Slash（Phase 3）</h1>

<button id="start">周回開始</button>
<button id="stop">停止</button>
<button id="reset">リセット</button>

<div class="box">
  <div class="enemyArea" id="enemyArea">
    <img id="enemyImg">
  </div>
  <div>
    HP: <span id="hp"></span>/<span id="hpMax"></span><br>
    DPS: <span id="dps"></span><br>
    Gold: <span id="gold"></span>
  </div>
</div>

<div class="box">
  <strong>装備中の武器</strong><br>
  <span id="equipWeapon"></span>
</div>

<div class="box">
  <strong>新しいドロップ</strong><br>
  <span id="dropWeapon"></span><br>
  <button id="equipBtn">装備する</button>
  <button id="discardBtn">捨てる</button>
</div>

<script>
(() => {
'use strict';

const SAVE_KEY = 'mini_hns_phase3_v1';
const IMG_DIR = './pic/enemy/';
const IMG_COUNT = 16;

let state = {
  hpMax:50,
  hp:50,
  gold:0,
  runs:0,
  baseDps:5,
  weapon:{ name:'素手', dps:0, rare:'common' },
  drop:null,
  inRun:false
};

const $ = id => document.getElementById(id);

function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
function load(){
  const s = localStorage.getItem(SAVE_KEY);
  if(s) state = JSON.parse(s);
}

function calcDps(){
  return state.baseDps + state.weapon.dps;
}

function rollWeapon(){
  const isRare = Math.random() < 0.2;
  const dps = isRare
    ? 6 + Math.floor(Math.random()*10)
    : 1 + Math.floor(Math.random()*5);
  return {
    name: isRare ? 'Rare Sword' : 'Common Sword',
    dps,
    rare: isRare ? 'rare' : 'common'
  };
}

function nextEnemy(){
  state.hpMax = 50 + state.runs * 10;
  state.hp = state.hpMax;
  $('enemyImg').src =
    IMG_DIR + 'enemy' + String(1+Math.floor(Math.random()*IMG_COUNT)).padStart(3,'0') + '.png';
}

function kill(){
  state.gold += 10;
  state.runs++;
  state.drop = rollWeapon();
  nextEnemy();
}

$('enemyImg').onclick = () => {
  if(!state.inRun) return;
  state.hp -= 1;
  if(state.hp <= 0) kill();
  render();
  save();
};

$('start').onclick = () => { state.inRun=true; nextEnemy(); render(); };
$('stop').onclick = () => { state.inRun=false; };
$('reset').onclick = () => { localStorage.removeItem(SAVE_KEY); location.reload(); };

$('equipBtn').onclick = () => {
  if(!state.drop) return;
  state.weapon = state.drop;
  state.drop = null;
  render(); save();
};

$('discardBtn').onclick = () => {
  state.drop = null;
  render(); save();
};

function render(){
  $('hp').textContent = Math.ceil(state.hp);
  $('hpMax').textContent = state.hpMax;
  $('gold').textContent = state.gold;
  $('dps').textContent = calcDps();

  $('equipWeapon').innerHTML =
    `<span class="weapon-${state.weapon.rare}">${state.weapon.name} (+${state.weapon.dps})</span>`;

  $('dropWeapon').innerHTML = state.drop
    ? `<span class="weapon-${state.drop.rare}">${state.drop.name} (+${state.drop.dps})</span>`
    : '---';
}

load();
render();
})();
</script>
</body>
</html>
