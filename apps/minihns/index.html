<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Idle Hack&Slash (Phase 2)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; line-height: 1.5; }
    button { padding: 10px 12px; margin: 4px 6px 4px 0; }
    .row { margin: 10px 0; }
    .box { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 10px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>Mini Idle Hack&Slash（Phase 2）</h1>

  <div class="row">
    <button id="btnStart">周回開始</button>
    <button id="btnStop">停止</button>
    <button id="btnReset">リセット（セーブ含む）</button>
  </div>

  <div class="box">
    <div>状態: <span id="status" class="mono">IDLE</span></div>
    <div>敵HP: <span id="enemyHp" class="mono">-</span> / <span id="enemyHpMax" class="mono">-</span></div>
    <div>自分DPS: <span id="dps" class="mono">-</span></div>
    <div>所持Gold: <span id="gold" class="mono">-</span></div>
    <div>周回数: <span id="runs" class="mono">-</span></div>
  </div>

  <div class="box">
    <div><strong>強化</strong></div>
    <div>DPS Lv: <span id="dpsLevel" class="mono">-</span></div>
    <button id="btnUpgradeDps">DPS強化 (<span id="dpsCost" class="mono">-</span> G)</button>
  </div>

  <div class="box">
    <div>ログ</div>
    <pre id="log" class="mono" style="white-space:pre-wrap; margin:0;"></pre>
  </div>

<script>
(() => {
  'use strict';

  /*********************
   * 定数
   *********************/
  const SAVE_KEY = 'mini_hns_phase2_v1';
  const TICK_MS = 100;

  const BASE_DPS = 5;
  const DPS_PER_LEVEL = 2;

  const BASE_ENEMY_HP = 50;
  const ENEMY_HP_GROWTH_PER_RUN = 10;

  const GOLD_REWARD_BASE = 10;

  const DPS_UPGRADE_BASE_COST = 20;
  const DPS_UPGRADE_COST_RATE = 1.5;

  /*********************
   * 状態
   *********************/
  let state = {
    gold: 0,
    runs: 0,
    dpsLevel: 0,
    dps: BASE_DPS,
    enemyHpMax: BASE_ENEMY_HP,
    enemyHp: BASE_ENEMY_HP,
    inRun: false,
  };

  let timerId = null;

  /*********************
   * DOM
   *********************/
  const $ = (id) => document.getElementById(id);

  const elStatus = $('status');
  const elEnemyHp = $('enemyHp');
  const elEnemyHpMax = $('enemyHpMax');
  const elDps = $('dps');
  const elGold = $('gold');
  const elRuns = $('runs');
  const elLog = $('log');
  const elDpsLevel = $('dpsLevel');
  const elDpsCost = $('dpsCost');

  const btnStart = $('btnStart');
  const btnStop = $('btnStop');
  const btnReset = $('btnReset');
  const btnUpgradeDps = $('btnUpgradeDps');

  /*********************
   * ユーティリティ
   *********************/
  function calcDps() {
    return BASE_DPS + state.dpsLevel * DPS_PER_LEVEL;
  }

  function calcDpsUpgradeCost() {
    return Math.floor(
      DPS_UPGRADE_BASE_COST * Math.pow(DPS_UPGRADE_COST_RATE, state.dpsLevel)
    );
  }

  function log(line) {
    const ts = new Date().toLocaleString();
    elLog.textContent = `[${ts}] ${line}\n` + elLog.textContent;
  }

  /*********************
   * セーブ/ロード
   *********************/
  function save() {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }

  function load() {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    try {
      const parsed = JSON.parse(raw);
      state = { ...state, ...parsed };
      state.dps = calcDps();
      return true;
    } catch {
      return false;
    }
  }

  function resetAll() {
    stopRun();
    localStorage.removeItem(SAVE_KEY);
    state = {
      gold: 0,
      runs: 0,
      dpsLevel: 0,
      dps: BASE_DPS,
      enemyHpMax: BASE_ENEMY_HP,
      enemyHp: BASE_ENEMY_HP,
      inRun: false,
    };
    render();
    log('リセットしました。');
  }

  /*********************
   * ゲーム進行
   *********************/
  function prepareNextEnemy() {
    state.enemyHpMax = BASE_ENEMY_HP + state.runs * ENEMY_HP_GROWTH_PER_RUN;
    state.enemyHp = state.enemyHpMax;
  }

  function startRun() {
    if (state.inRun) return;
    state.inRun = true;
    prepareNextEnemy();
    log(`周回開始：敵HP=${state.enemyHpMax}, DPS=${state.dps}`);
    timerId && clearInterval(timerId);
    timerId = setInterval(tick, TICK_MS);
    render();
  }

  function stopRun() {
    state.inRun = false;
    timerId && clearInterval(timerId);
    timerId = null;
    render();
  }

  function tick() {
    if (!state.inRun) return;

    const damage = state.dps * (TICK_MS / 1000);
    state.enemyHp = Math.max(0, state.enemyHp - damage);

    if (state.enemyHp <= 0) {
      state.runs += 1;
      state.gold += GOLD_REWARD_BASE;
      log(`撃破！ +${GOLD_REWARD_BASE}G`);
      prepareNextEnemy();
    }

    save();
    render();
  }

  /*********************
   * 強化
   *********************/
  function upgradeDps() {
    const cost = calcDpsUpgradeCost();
    if (state.gold < cost) {
      log('Goldが足りません。');
      return;
    }
    state.gold -= cost;
    state.dpsLevel += 1;
    state.dps = calcDps();
    log(`DPS強化！ Lv${state.dpsLevel}（DPS=${state.dps}）`);
    save();
    render();
  }

  /*********************
   * 表示
   *********************/
  function render() {
    elStatus.textContent = state.inRun ? 'RUNNING' : 'IDLE';
    elEnemyHp.textContent = Math.ceil(state.enemyHp);
    elEnemyHpMax.textContent = state.enemyHpMax;
    elDps.textContent = state.dps;
    elGold.textContent = state.gold;
    elRuns.textContent = state.runs;
    elDpsLevel.textContent = state.dpsLevel;
    elDpsCost.textContent = calcDpsUpgradeCost();
  }

  /*********************
   * イベント
   *********************/
  btnStart.onclick = startRun;
  btnStop.onclick = () => { log('停止しました。'); stopRun(); save(); };
  btnReset.onclick = resetAll;
  btnUpgradeDps.onclick = upgradeDps;

  /*********************
   * 初期化
   *********************/
  const loaded = load();
  render();
  log(loaded ? 'セーブデータをロードしました。' : '新規開始です。');
})();
</script>
</body>
</html>
